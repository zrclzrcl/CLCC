-- Clean up existing tables if they exist
DROP TABLE IF EXISTS test_table;
DROP TABLE IF EXISTS json_data;

-- Create a table with various data types
CREATE TABLE test_table (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    value DECIMAL(10, 2),
    created_at DATE,
    status BOOLEAN
);

-- Insert sample data into the table
INSERT INTO test_table VALUES
(1, 'Alice', 100.5, '2023-01-01', true),
(2, 'Bob', 200.75, '2023-02-15', false),
(3, 'Charlie', 300.0, '2023-03-20', true);

-- Create a JSON data table
CREATE TABLE json_data (
    id INTEGER PRIMARY KEY,
    json_col JSONB
);

-- Insert sample JSON data
INSERT INTO json_data VALUES
(1, '{"name": "John", "age": 30, "hobbies": ["reading", "music"]}'),
(2, '{"name": "Jane", "age": 25, "hobbies": ["painting", "cooking"]}');

-- Create indexes on the tables
CREATE INDEX idx_name ON test_table(name);
CREATE INDEX idx_status ON test_table(status);

-- Complex SELECT with CTE and window function
WITH cte AS (
    SELECT id, name, value,
           ROW_NUMBER() OVER (ORDER BY value DESC) as rank
    FROM test_table
)
SELECT cte.id, cte.name, cte.value, cte.rank,
       t2.status
FROM cte
JOIN test_table t2 ON cte.id = t2.id
WHERE cte.rank <= 3
GROUP BY cte.id, cte.name, cte.value, cte.rank, t2.status;

-- Test JSON operations
SELECT json_col->>'name' AS name,
       (json_col->'age')::INTEGER AS age,
       json_col->'hobbies' AS hobbies
FROM json_data;

-- Test UNION of two SELECTs
SELECT 'Alice' AS name, 30 AS age
UNION
SELECT 'Bob', 25;

-- Test JOIN operations
SELECT t1.name, t2.status
FROM test_table t1
LEFT JOIN test_table t2 ON t1.id = t2.id + 1;

-- Test date functions
SELECT created_at,
       DATE_TRUNC('month', created_at) AS truncated_month
FROM test_table;