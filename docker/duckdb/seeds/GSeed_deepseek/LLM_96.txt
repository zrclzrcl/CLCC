CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username TEXT NOT NULL,
    email TEXT UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS transactions (
    transaction_id UUID PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    amount DECIMAL(10, 2) CHECK (amount > -1000.00 AND amount < 1000.00),
    transaction_date DATE DEFAULT CURRENT_DATE,
    status TEXT CHECK (status IN ('pending', 'completed', 'failed'))
);

INSERT INTO users VALUES
    (1, 'john_doe', 'john@example.com', '2023-01-01 00:00:00', NULL, TRUE),
    (2, 'jane_smith', 'jane@example.com', '2023-01-02 00:00:00', '2023-01-05 12:00:00', FALSE),
    (3, 'bob_jones', 'bob@example.com', '2023-01-03 00:00:00', '2023-01-04 08:00:00', TRUE);

INSERT INTO transactions VALUES
    ('11111111-1111-1111-1111-111111111111', 1, 100.50, '2023-01-01', 'completed'),
    ('22222222-2222-2222-2222-222222222222', 1, -50.75, '2023-01-02', 'pending'),
    ('33333333-3333-3333-3333-333333333333', 2, 75.25, '2023-01-03', 'failed'),
    ('44444444-4444-4444-4444-444444444444', 3, 200.00, '2023-01-04', 'completed'),
    ('55555555-5555-5555-5555-555555555555', 3, -25.00, '2023-01-05', 'pending');

WITH user_activity AS (
    SELECT
        u.id,
        u.username,
        t.transaction_id,
        t.amount,
        t.status,
        ROW_NUMBER() OVER (PARTITION BY u.id ORDER BY t.transaction_date DESC) as rn,
        RANK() OVER (ORDER BY t.amount DESC) as amount_rank,
        SUM(t.amount) OVER (PARTITION BY u.id) as total_spent
    FROM users u
    LEFT JOIN transactions t ON u.id = t.user_id
    WHERE u.is_active AND t.status != 'failed'
)
SELECT
    id,
    username,
    transaction_id,
    amount,
    status,
    rn,
    amount_rank,
    total_spent,
    CASE
        WHEN total_spent > 100 THEN 'high spender'
        WHEN total_spent BETWEEN 50 AND 100 THEN 'medium spender'
        ELSE 'low spender'
    END as spending_category
FROM user_activity
ORDER BY id, rn;