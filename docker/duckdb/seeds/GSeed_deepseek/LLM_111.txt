BEGIN TRANSACTION;
CREATE TABLE t1(
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    score REAL,
    active BOOLEAN DEFAULT TRUE
);
INSERT INTO t1 VALUES(1, 'Alice', 95.5, TRUE);
INSERT INTO t1 VALUES(2, 'Bob', 87.2, FALSE);
INSERT INTO t1 VALUES(3, 'Charlie', NULL, TRUE);
CREATE TABLE t2(
    id INTEGER PRIMARY KEY,
    event TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
INSERT INTO t2 VALUES(1, 'login', '2024-01-01 12:00:00');
INSERT INTO t2 VALUES(2, 'logout', NULL);
CREATE INDEX idx_t1_name ON t1(name);
WITH cte AS (
    SELECT id, name, score 
    FROM t1 
    WHERE active = TRUE
)
INSERT INTO t2(event, timestamp) 
SELECT 'active_user' AS event, CURRENT_TIMESTAMP 
FROM cte;
SELECT 
    t1.id, 
    t1.name, 
    t2.event,
    RANK() OVER (ORDER BY score DESC) AS rank_score
FROM t1
JOIN t2 ON t1.id = t2.id;
COMMIT;