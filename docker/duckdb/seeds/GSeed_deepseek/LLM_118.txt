PRAGMA enable_recursive_triggers = true;

CREATE TABLE t1(
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    value NUMERIC UNIQUE,
    status BOOLEAN DEFAULT false
);

CREATE INDEX idx_t1_name ON t1(name);
CREATE UNIQUE INDEX idx_t1_status_value ON t1(status, value);

WITH cte AS (
    SELECT 1 as a, 'test' as b
)
INSERT INTO t1(id, name, value, status) 
SELECT 100, b, 99.99, true FROM cte;

CREATE TRIGGER tr_t1_after_insert AFTER INSERT ON t1 BEGIN
    UPDATE t1 SET status = true WHERE id = NEW.id;
END;

INSERT INTO t1(id, name, value) VALUES(1, 'Alice', 100);
INSERT INTO t1(id, name, value) VALUES(2, 'Bob', 200);

SELECT id, name, RANK() OVER (ORDER BY value DESC) as rank FROM t1;

BEGIN;
    INSERT INTO t1(id, name, value) VALUES(3, 'Charlie', 300);
COMMIT;

BEGIN;
    INSERT INTO t1(id, name, value) VALUES(4, 'David', 400);
    ROLLBACK;