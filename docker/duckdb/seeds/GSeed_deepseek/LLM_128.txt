-- Create Table t1 with various data types and constraints
CREATE TABLE t1 (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    age SMALLINT CHECK(age >= 0),
    balance DECIMAL(10,2),
    joined_date DATE DEFAULT CURRENT_DATE,
    active BOOLEAN DEFAULT TRUE,
    data JSONB,
    hobbies TEXT[]
);

-- Insert sample data into t1 with edge cases
INSERT INTO t1 (id, name, age, balance, joined_date, active, data, hobbies) VALUES
(1, 'Alice', 30, 1000.50, '2024-01-01', TRUE, '{"key": "value"}', ARRAY['reading', 'hiking']),
(2, 'Bob', NULL, -500.75, '2024-01-02', FALSE, NULL, NULL),
(3, '', 0, 0.00, CURRENT_DATE, TRUE, '{}', ARRAY[]::TEXT[]);

-- Create Table t2 referencing t1
CREATE TABLE t2 (
    id INTEGER PRIMARY KEY,
    t1_id INTEGER REFERENCES t1(id),
    score DECIMAL(5,2)
);

-- Insert sample data into t2
INSERT INTO t2 (id, t1_id, score) VALUES
(1, 1, 99.99),
(2, 2, NULL),
(3, 3, 0.00);

-- Perform a join and filter query
SELECT t1.name, t2.score 
FROM t1 
JOIN t2 ON t1.id = t2.t1_id 
WHERE t2.score > 50 
ORDER BY t1.name;

-- Use CTE with window function
WITH cte AS (
    SELECT id, name, balance, ROW_NUMBER() OVER (ORDER BY joined_date DESC) as rn
    FROM t1
)
SELECT * 
FROM cte 
WHERE rn <= 2;