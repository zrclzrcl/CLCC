-- Create a table with various data types and constraints
CREATE TABLE IF NOT EXISTS t1 (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    score DECIMAL(5,2) DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('active', 'inactive') NOT NULL,
    metadata JSONB
);

-- Insert sample data with different value combinations
INSERT INTO t1 (id, name, score, created_at, status, metadata)
VALUES 
    (1, 'Alice', 95.5, '2023-01-01 00:00:00', 'active', '{"age": 30, "city": "New York"}'),
    (2, 'Bob', NULL, CURRENT_TIMESTAMP, 'inactive', '{"age": 25, "city": "Los Angeles"}'),
    (3, 'Charlie', 87.5, '2023-01-02 12:34:56', 'active', '{"age": NULL, "city": "Chicago"}');

-- Test ON CONFLICT with REPLACE and IGNORE
INSERT OR REPLACE INTO t1 (id, name) VALUES (1, 'Alicia');
INSERT OR IGNORE INTO t1 (id, name) VALUES (2, 'Robert');

-- Update operations with different conditions
UPDATE t1 SET score = 85.0 WHERE id = 1;
UPDATE t1 SET status = 'inactive' WHERE score > 90;

-- Test NULL handling and window functions
SELECT 
    id,
    name,
    ROW_NUMBER() OVER (ORDER BY created_at DESC) AS row_num,
    RANK() OVER (ORDER BY score DESC) AS rank_score
FROM t1
WHERE metadata->>'age' IS NOT NULL;

-- Test Common Table Expressions (CTE)
WITH cte AS (
    SELECT 
        id, 
        name, 
        status,
        EXTRACT(YEAR FROM created_at) AS year_joined
    FROM t1
)
SELECT * FROM cte WHERE year_joined >= 2023;

-- Test JSONB operations
SELECT metadata->>'city' AS city_name FROM t1 WHERE status = 'active';

-- Test different join types and NULL handling
CREATE TABLE IF NOT EXISTS t2 (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    team_id INTEGER REFERENCES t1(id)
);

INSERT INTO t2 VALUES 
    (1, 'Team A', 1),
    (2, 'Team B', NULL);

SELECT 
    t1.name AS member_name,
    t2.name AS team_name
FROM t1
LEFT JOIN t2 ON t1.id = t2.team_id;

-- Cleanup operations
DELETE FROM t1 WHERE id > 3;
DROP TABLE IF EXISTS t2;