-- Create a table with various data types to test edge cases
CREATE TABLE users(
    id INTEGER PRIMARY KEY,
    username TEXT NOT NULL,
    email TEXT UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN,
    bio BLOB
);

-- Create another table for testing relationships and indexing
CREATE TABLE user_events(
    event_id INTEGER PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    event_type TEXT CHECK(event_type IN ('login', 'logout', 'update')),
    event_time TIMESTAMP,
    data JSONB
);

-- Create indexes to test different index types and conditions
CREATE UNIQUE INDEX idx_unique_username ON users(username);
CREATE INDEX idx_email_lower ON users(LOWER(email));
CREATE INDEX idx_event_time_type ON user_events(event_time, event_type) WHERE is_active = true;

-- Insert sample data with various edge cases
INSERT INTO users VALUES
    (1, 'admin', 'admin@example.com', CURRENT_TIMESTAMP, true, X'7468697320697320612074657374'),
    (2, 'guest', 'guest@example.com', '2024-01-01 00:00:00', false, NULL);

-- Insert more data into user_events
INSERT INTO user_events VALUES
    (1, 1, 'login', CURRENT_TIMESTAMP - INTERVAL '1 hour', '{"ip": "192.168.1.1"}'),
    (2, 1, 'logout', CURRENT_TIMESTAMP, '{}');

-- Create a trigger to test procedural logic
CREATE TRIGGER update_last_modified
AFTER UPDATE ON users
FOR EACH ROW
WHEN NEW.is_active != OLD.is_active
EXECUTE FUNCTION log_update(NEW.id);

-- Create views to test different query patterns
CREATE VIEW active_users AS
SELECT id, username, created_at
FROM users
WHERE is_active = true;

CREATE VIEW user_activity_stats AS
WITH user_events_cte AS (
    SELECT user_id, event_type, DATE(event_time) as event_date
    FROM user_events
)
SELECT 
    u.id,
    u.username,
    COUNT(*) as total_events,
    COUNT(DISTINCT event_type) as unique_events,
    MIN(event_date) as first_activity,
    MAX(event_date) as last_activity
FROM users u
LEFT JOIN user_events_cte e ON u.id = e.user_id
GROUP BY u.id, u.username;

-- Test complex queries with window functions and joins
SELECT 
    u.id,
    u.username,
    e.event_type,
    e.event_time,
    SUM(CASE WHEN e.event_type = 'login' THEN 1 ELSE 0 END) OVER (PARTITION BY u.id ORDER BY e.event_time) as login_count
FROM users u
JOIN user_events e ON u.id = e.user_id
WHERE e.event_time > CURRENT_TIMESTAMP - INTERVAL '24 hours';

-- Test transaction and savepoint functionality
BEGIN;
    INSERT INTO users VALUES (3, 'test_user', 'test@example.com', CURRENT_TIMESTAMP, true, NULL);
    SAVEPOINT my_savepoint;
    UPDATE users SET username = 'test_user_updated' WHERE id = 3;
    ROLLBACK TO my_savepoint;
COMMIT;

-- Clean up resources
DROP TABLE IF EXISTS user_events;