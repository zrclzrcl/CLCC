-- Create table with primary key and constraints
CREATE TABLE t1(
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    data BLOB,
    active BOOLEAN DEFAULT TRUE
);

-- Insert sample data into t1
INSERT INTO t1 VALUES(1, 'Alice', X'0123456789AB', TRUE);
INSERT INTO t1 VALUES(2, 'Bob', X'ABCDEF', FALSE);
INSERT INTO t1 VALUES(3, 'Charlie', NULL, TRUE);

-- Create table t2 with foreign key reference to t1
CREATE TABLE t2(
    id INTEGER PRIMARY KEY,
    t1_id INTEGER,
    details TEXT,
    FOREIGN KEY(t1_id) REFERENCES t1(id)
);

-- Insert data into t2 referencing t1
INSERT INTO t2 VALUES(1, 1, 'Details for Alice');
INSERT INTO t2 VALUES(2, 2, 'Details for Bob');

-- Create index on t1.id for faster lookups
CREATE INDEX idx_t1_id ON t1(id);

-- Alter table to add a timestamp column with default value
ALTER TABLE t1 ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

-- Rename the 'active' column to 'is_active'
ALTER TABLE t1 RENAME COLUMN active TO is_active;

-- Insert more data into t1 after altering structure
INSERT INTO t1 VALUES(4, 'David', X'123456', TRUE, CURRENT_TIMESTAMP);

-- Begin transaction for updates
BEGIN;
    UPDATE t1 SET is_active = FALSE WHERE id = 3;
    DELETE FROM t2 WHERE t1_id = 3;
COMMIT;

-- Create a view combining t1 and t2
CREATE VIEW vw_joined AS
SELECT t1.id, t1.name, t2.details 
FROM t1 JOIN t2 ON t1.id = t2.t1_id;

-- Use window function to rank active users
SELECT name, ROW_NUMBER() OVER(ORDER BY id) as rank
FROM t1 WHERE is_active = TRUE;

-- Test CTE with a simple example
WITH sample_cte AS (
    SELECT id, name FROM t1 WHERE is_active = TRUE
)
SELECT * FROM sample_cte;