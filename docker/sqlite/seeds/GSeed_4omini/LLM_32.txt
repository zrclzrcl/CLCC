CREATE TABLE users(id INTEGER PRIMARY KEY, name TEXT NOT NULL, email TEXT UNIQUE);
CREATE TABLE orders(id INTEGER PRIMARY KEY, user_id INTEGER, amount REAL, order_date TEXT, FOREIGN KEY(user_id) REFERENCES users(id));
CREATE TABLE products(id INTEGER PRIMARY KEY, product_name TEXT, price REAL);
CREATE TABLE order_items(order_id INTEGER, product_id INTEGER, quantity INTEGER, FOREIGN KEY(order_id) REFERENCES orders(id), FOREIGN KEY(product_id) REFERENCES products(id));

INSERT INTO users(name, email) VALUES('Alice', 'alice@example.com');
INSERT INTO users(name, email) VALUES('Bob', 'bob@example.com');
INSERT INTO products(product_name, price) VALUES('Widget', 19.99);
INSERT INTO products(product_name, price) VALUES('Gadget', 29.99);
INSERT INTO orders(user_id, amount, order_date) VALUES(1, 39.98, '2023-01-01');
INSERT INTO order_items(order_id, product_id, quantity) VALUES(1, 1, 2);
INSERT INTO order_items(order_id, product_id, quantity) VALUES(1, 2, 1);

-- Testing edge cases with NULL values and subqueries
SELECT * FROM users WHERE id = (SELECT user_id FROM orders WHERE amount IS NULL);
SELECT * FROM orders WHERE user_id IN (SELECT id FROM users WHERE email IS NOT NULL);
SELECT COUNT(*) FROM order_items GROUP BY order_id HAVING COUNT(*) > 1;

-- Testing joins with potential empty results
SELECT u.name, o.amount FROM users u LEFT JOIN orders o ON u.id = o.user_id WHERE o.user_id IS NULL;
SELECT p.product_name, oi.quantity FROM products p LEFT JOIN order_items oi ON p.id = oi.product_id WHERE oi.order_id IS NULL;

-- Testing transactions and error handling
BEGIN TRANSACTION;
INSERT INTO users(name, email) VALUES('Charlie', NULL); -- This will fail due to NOT NULL constraint
ROLLBACK;